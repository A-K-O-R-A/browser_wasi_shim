<meta charset="utf-8">
<script type="module">
    import * as wasi from "./wasi_defs.js";
    import { Fd, Stdio } from "./fd.js";
    import { File, Directory } from "./fs_core.js";
    import { OpenFile, OpenDirectory, PreopenDirectory } from "./fs_fd.js";
    import WASI from "./wasi.js";

    (async function () {
        document.body.style.fontFamily = "monospace";
        document.body.style.whiteSpace = "pre";
        document.body.innerText = "Downloading";
        let wasm = await WebAssembly.compileStreaming(fetch("rustc_binary.wasm"));
        //let wasm = await WebAssembly.compileStreaming(fetch("/rust_out.wasm"));
        document.body.innerText = "Instantiating";

        async function load_external_file(path) {
            return new File(await (await (await fetch(path)).blob()).arrayBuffer());
        }

        let args = ["rustc", "./hello.rs", "--sysroot", "/sysroot", "--target", "x86_64-unknown-linux-gnu", "-Cpanic=abort", "-Ccodegen-units=1"];
        let env = ["RUSTC_LOG=trace"];
        let fds = [
            new Stdio(),
            new Stdio(),
            new Stdio(),
            new PreopenDirectory("/tmp", {}),
            new PreopenDirectory(".", {
                "hello.rs": new File(new TextEncoder("utf-8").encode(`fn main() { println!("Hello World!"); }`)),
            }),
            new PreopenDirectory("/sysroot", {
                "lib": new Directory({
                    "rustlib": new Directory({
                        "wasm32-wasi": new Directory({
                            "lib": new Directory({}),
                        }),
                        "x86_64-unknown-linux-gnu": new Directory({
                            "lib": new Directory(await (async function () {
                                let dir = {};
                                for (let file of [
                                    "libcore-b4a7d25c83ac0d14.rlib",
                                    "librustc_std_workspace_core-18038143f92ab7ad.rlib",
                                    "libcompiler_builtins-f0b22b2b55b20afb.rlib",
                                    "liballoc-072489b01506fb72.rlib",
                                    "librustc_std_workspace_alloc-eeb0fd7b28eabbfd.rlib",
                                    "liblibc-f3a5d2870a74e12d.rlib",
                                    "libunwind-d85e8e3df3b56ff5.rlib",
                                    "libcfg_if-6b32ca81b3ffdff5.rlib",
                                    "libbacktrace_sys-93675d780e5d0925.rlib",
                                    "libbacktrace-30a7c0899d033fc0.rlib",
                                    "librustc_demangle-92b41332709a8741.rlib",
                                    "libhashbrown-f92f11aad8210abe.rlib",
                                    "libstd-358912be09271fe6.rlib",
                                    "libpanic_abort-9fa38857c2678ded.rlib",
                                ]) {
                                    dir[file] = await load_external_file("/sysroot/lib/rustlib/x86_64-unknown-linux-gnu/lib/" + file);
                                }
                                return dir;
                            })()),
                        }),
                    }),
                }),
            }),
        ];
        window.fds = fds;

        let w = new WASI(args, env, fds);

        let inst = await WebAssembly.instantiate(wasm, {
            "wasi_snapshot_preview1": w.wasiImport,
        });
        document.body.innerText = "Executing\n";
        console.log(inst.exports);
        w.start(inst);
        document.body.innerText += "\nDone";

        console.log(fds[4].directory);
        console.log(fds[4].directory["hello.hello.7rcbfp3g-cgu.0.rcgu.o"].data);
        document.body.innerHTML += "<br><a href='" + URL.createObjectURL(new Blob([fds[4].directory["hello.hello.7rcbfp3g-cgu.0.rcgu.o"].data], { type: "application/elf" })) + "'>Download object</a>";
        document.body.innerHTML += "<br><a href='" + URL.createObjectURL(new Blob([fds[4].directory["hello.allocator_shim.rcgu.o"].data], { type: "application/elf" })) + "'>Download allocator shim</a>";
    })();
</script>
